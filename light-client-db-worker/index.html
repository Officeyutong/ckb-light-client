<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.5.0/dist/semantic.min.css">
    <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.5.0/dist/semantic.min.js"></script>
    <script type="module">
        const dbWorker = new Worker("./db.js", { type: "module" });
        const inputBuffer = new SharedArrayBuffer(4 + 4 + (1 << 20));
        const outputBuffer = new SharedArrayBuffer(4 + 4 + (1 << 20));
        window.initWorkers = async () => {
            dbWorker.postMessage({
                inputBuffer,
                outputBuffer,
                wasmModulePath: "./pkg/light_client_db_worker_bg.wasm",
                path: "testdb"
            });
            console.log("message posted");
            await new Promise((res, rej) => {
                dbWorker.onmessage = () => res();
                dbWorker.onerror = (evt) => rej(evt);
            });
            window.dbWorker = dbWorker;
        }
        window.addRecord = async (key, value) => {
            const i32arrout = new Int32Array(outputBuffer);
            const i32arrin = new Int32Array(inputBuffer);
            const u8in = new Uint8Array(inputBuffer);
            const u8out = new Uint8Array(outputBuffer);

            i32arrout[0] = 0;
            const obj = new TextEncoder().encode(JSON.stringify({
                type: "Put",
                kvs: [
                    {
                        key: [...key],
                        value: [...value],
                    }
                ]
            }));
            i32arrin[1] = obj.length;
            u8in.set(obj, 8);
            i32arrin[0] = 1;
            Atomics.notify(i32arrin, 0);
            await Atomics.waitAsync(i32arrout, 0, 0).value;
            const len = i32arrout[1];
            console.log("len=", len);
            const subarr = new Uint8Array([...u8out.subarray(8, 8 + len)]);
            console.log(u8out,new TextDecoder().decode(subarr));
            console.log(JSON.parse(new TextDecoder().decode(subarr)));

        }
    </script>
</head>

<body>
    <div style="margin-top: 10%;margin-left: 10%;margin-right: 10%;">
        <button class="ui button" onclick="initWorkers()">Initialize workers</button>
        <div class="ui divider"></div>

    </div>
</body>

</html>
